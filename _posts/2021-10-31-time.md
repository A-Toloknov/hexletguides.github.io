---
title: Что такое время
subtitle: Или как не наступить на временнЫе грабли
description: Как современный компьютер хранит информацию, сколько сейчас времени,
как он отсчитывает секунды, почему почти никогда не ошибается и как с ним работать
image:
author: Вериго Александр
---

## Как компьютер определяет человеческое время?

Представим ситуацию, что Вы откопали в кладовой старый компьютер и любопытства ради
решили попробовать его включить. На удивление компьютер запускается, несмотря на
10 лет простоя. Но есть небольшая проблема: он уверен, что сегодня 1 января 1970
года. Такая ситуация не может не заставить задуматься, как компьютеры
хранят текущее время? У них нет внутри никаких пружин или маятников, которые
могли бы отсчитывать секунды, как в часах. Так как же они показывают верное
время даже если отключить их на несколько часов? И почему ваш компьютер перепутал
время, только проведя 10 лет в кладовке, а не делал это на каждый перезапуск?

### Маятник как первый секундомер

Чтобы разобраться в этом вопросе, нам стоит сначала дать ответ на то, как мы в
принципе можем точно измерять время. На самом деле, это не такая простая задача,
когда под рукой нет часов. Да, мы всё ещё можем отсчитывать дни, месяцы и годы,
мы даже можем разбить день на часы. Но тяжело найти ориентир, который мог бы нам
подсказать количество прошедших секунд.

Традиционно принято считать, что первым эту задачу решил итальянский ученый XVII
века [Галилео Галилей](https://ru.wikipedia.org/wiki/%D0%93%D0%B0%D0%BB%D0%B8%D0%BB%D0%B5%D0%B9,_%D0%93%D0%B0%D0%BB%D0%B8%D0%BB%D0%B5%D0%BE).
Его биографы утверждают, что Галилео, которому нужно было точно знать, сколько длился
тот или иной эксперимент, для измерения времени считал количество своих
сердцебиений. По легенде, однажды он наблюдал за раскачивающимся канделябром в кафедральном
соборе Пизы и заметил, что каждое колебание канделябра занимало одинаковое
количество сердцебиений, и не изменялось даже со временем, когда амплитуда
движения затухала. Таким образом он понял, что колебания маятника позволяют
более точно засекать время.

### Можно ли использовать колебания для подсчета времени в компьютере?

Когда в 70-е - 80-е годы инженеры впервые столкнулись с задачей отсчета
человеческого времени, как ни странно, они обратились к трудам итальянского ученого.
Дело в том, что маятник - не единственный возможный источник колебаний. У любого
современного персонального компьютера есть своеобразное "сердце" - Центральное
процессорное устройство (ЦПУ) или просто процессор. Это очень сложное устройство,
которое выполняет множество функций, но для нас важно то, что внутри него есть
небольшое устройство, которое, когда через него проходит ток, испускает равномерные
электрические колебания с одинаковой [частотой](https://en.wikipedia.org/wiki/Clock_rate).
Частота этих колебаний измеряется в Герцах (Гц) и определяет количество операций,
которое процессор может выполнить за одну секунду.

Представим, что у нас есть одноядерный процессор с частотой 1 Гц. Такой процессор
может выполнять одну операцию за одну секунду, и чтобы отсчитывать с его помощью
время мы можем просто хранить количество колебаний процессора. К сожалению,
если мы будем использовать единственную доступную нам операцию в секунду для
увеличения счетчика колебаний, то наш процессор будет совершенно непригоден
для чего либо ещё, потому что для остальных программ не останется места.
Конечно, современные процессоры не такие медленные, их частота измеряется в
Гигагерцах (ГГц), то есть в 1 000 000 000 операций в секунду. Но даже имея
такую мощь, чтобы засечь время, нам бы пришлось считать каждое колебание процессора.

Для решения этой проблемы был придуман кварцевый генератор. Это устройство
представляет собой тончайшую кремниевую пластину, которая под воздействием
электрического напряжения начинает равномерно расширяться и сжиматься обратно,
[генерируя небольшой электрический заряд на своей поверхности](https://ru.wikipedia.org/wiki/%D0%9F%D1%8C%D0%B5%D0%B7%D0%BE%D1%8D%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D1%8D%D1%84%D1%84%D0%B5%D0%BA%D1%82)
Таким образом, механические колебания пластины сопровождаются синхронными, равномерными
колебаниями электрического заряда.

```
                      |            |
                      |------------|
    -->--->--->-->--->| Генератор  | >>>>>>>>>
      Переменный ток  |------------|  100 Гц
                      |            |
```

Полученные равномерные колебания принято называть таймером, потому что позволяют
процессору синхронизировать производимые им операции во времени. Таким образом,
у компьютера есть свой собственный таймер и своё собственное понимание времени.

### От компьютерного времени к человеческому

Получается, что у компьютера есть таймер, но нет нужды замерять человеческое время,
оно для него довольно бесполезно. Как правило, эту задачу на себя берут операционные
системы (ОС). Поскольку ОС обычно знает, с какой частотой работает кварцевый генератор,
то она знает и сколько времени проходит между каждым срабатыванием таймера
(срабатывание таймера называют тик (tick) или джиффи (jiffy)). Это посчитать
довольно просто, если генератор работает на частоте 100 Гц, то период между
тиками равен 1/100 секунды или 10 миллисекундам. Операционная система создает в памяти
переменную, которую обычно называют jiffies, и увеличивает ее на единицу каждый раз,
когда процессор оповещает ее, что произошел новый тик. Соответственно, чтобы узнать,
как долго включен компьютер, системе достаточно умножить размер периода между тиками
на количество этих самых тиков. А чтобы узнать текущее время, достаточно добавить
прошедшее время к времени на момент старта системы. Но как узнать человеческое время
на момент старта системы?

### RTC (Real Time Clock), или Часы реального времени

Интересно, но первые персональные компьютеры, такие как [IBM PC](https://en.wikipedia.org/wiki/IBM_Personal_Computer#Design_process)
или [Apple II](https://en.wikipedia.org/wiki/Apple_II), не умели следить за тем,
сколько прошло время после выключения, а [спрашивали его на старте](https://www.youtube.com/watch?v=X3aqJQPQKhs).
Для решения этой задачи снова пригодился кварцевый генератор. Поскольку ему
неважно из какого источника получать электрическое напряжение, то довольно быстро
поняли, что достаточно подключить генератор к обычной литиевой батарейке, чтобы
получать равномерные электрические колебания. Если в эту схему еще добавить
бинарный счетчик, который увеличивается на каждое колебание, то мы получим
устройство, которое может фиксировать человеческое время. Оно так и называется -
RTC (Real Time Clock), или Часы реального времени. Частота колебаний на
выходе из RTC обычно 32 768 Гц или 2^15 Гц, что удобно использовать в бинарных счетчиках.

```
                                          RTC
|-------------------- |---------- |-------------------- |                                     |
|                     |           |                     |         32 768 Гц                   |
| Литиевая батарейка  | ->->->->  | Кварцевый генератор | >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>    |
|                     | ток       |                     | Равномерные электрические колебания | Бинарный счетчик
|                     |           |                     |                                     |
|-------------------- |---------- |-------------------- |                                     |
```

Как оказалось, наш старый сервер перепутал время именно из-за того, что
батарейка в его часах реального времени села от старости: когда сервер запустился,
он не смог считать время из RTC и выставил стандартное стартовое время - 1 января
1970 года.

### Network Time Protocol

Итак, RTC позволяет компьютеру отсчитывать миллисекунды даже когда он выключен.
Но стандартные RTC имеют погрешность 1,7 - 8,6 секунд в день, значит за год они
могут потерять целый час. Мы иногда сталкиваемся с этой проблемой в реальной жизни,
когда нам приходится поправлять время на наручных кварцевых часах или на
микроволновке, которые тоже используют RTC. Но нам никогда не приходится делать
этого на компьютере. Да и на старте компьютер больше не спрашивает текущее время.
Когда он подключается к сети интернет, он может использовать NTP (Network Time
Protocol - протокол сетевого времени) для того, чтобы синхронизироваться с сервером
точного времени в сети интернет. Этот протокол даже учитывает время передачи
данных между источником и компьютером и компенсирует его. В публичной сети он
позволяет достигать точности 10 мс.

### Как это работает все вместе?

```
|       | Включение компьютера   |                       | Периодически опрашивает NTP  |      |
|------ |----------------------- |---------------------- |----------------------------- |----- |
| RTC   | ->->->->               | Операционная система  | ->->->->                     | NTP  |
| RTC   | <-<-<-<-               | Операционная система  | <-<-<-<-                     | NTP  |
|------ |----------------------- |---------------------- |----------------------------- |----- |
|       | Выключение компьютера  |                       |                              |      |
```

Когда наш компьютер выключен, RTC продолжает работу и отсчитывает время.
Когда мы нажимаем кнопку запуска, операционная система забирает время из RTC и
начинает отслеживать время самостоятельно, используя таймер процессора. Время от
времени, операционная система по NTP получает точное время и поправляет свой
внутренний счетчик. Когда мы выключаем компьютер, за дело снова берется RTC.

## А что такое Unix-таймстамп и epoch?

Как уже говорилось, операционная система для того, чтобы отслеживать человеческое
время, создает в памяти компьютера переменную jiffy, в которой хранит количество
тиков с момента старта системы. Но как с помощью этого показывать человеку календарь,
который мог бы идти на несколько лет вперёд или назад. В 70-е годы прошлого века,
эту проблему решили инженеры из Bell Labs при разработке операционной системы Unix
(которая заложит фундамент для появления современных Linux и MacOS).

Они договорились, что в системе будет переменная, которая будет увеличиваться на
каждый тик генератора, начиная от какой-то заданной даты. Под эту переменную
отводилось целое число со знаком (eng. signed integer) размером в 32 бита
(то есть от −2 147 483 648 (-2^31) до 2 147 483 647 (2^31−1)). Подавляющее
большинство генераторов тогда работали на частоте 60 Гц, то есть 60 тиков в
секунду, поэтому такая переменная могла представлять временной промежуток не
более 829 дней. Поэтому в [версии Unix от 1971 года этой датой стало 1971-01-01 00:00:00](http://man.cat-v.org/unix-1st/2/sys-time)
[На следующий год этой датой стало 1972-01-01 00:00:00](https://minnie.tuhs.org/cgi-bin/utree.pl?file=V3/man/man2/time.2).
Это было довольно неудобно, потому что нужно было переставлять время каждый год
и нельзя было заглянуть в прошлое или будущее более чем на 2.5 года. Поэтому в
4 версии Unix в 1973 году за [epoch была взята дата 1970-01-01 00:00:00](https://minnie.tuhs.org/cgi-bin/utree.pl?file=V4/man/man2/time.2),
а в переменной стали хранить секунды с epoch. Позже это вошло в международный стандарт
и используется по сей день.

(Если у вас Linux или MacOS, вбейте в терминале `date +"%s"`, чтобы получить текущий Unix-timestamp)

## Выводы

- В любом современном ПК есть процессор, который умеет производить колебания
с равными интервалами.
- Зная период этих колебаний, операционная система компьютера может считать
человеческое время.
- С помощью протокола NTP операционная система может обращаться к серверам
точного времени, для скорректировать своих часов
- Когда компьютер выключен, время считает специальное устройство - RTC, которое
питается от батареи
