---
title: Что такое время
subtitle: Или как Ваш компьютер понимает, какой сейчас час
description: Как современный компьютер хранит информацию, сколько сейчас времени,
как он отсчитывает секунды и почему почти никогда не ошибается
image:
author: Вериго Александр
---

Пару дней назад мы на работе разбирали кладовку и наткнулись на наш
самый первый сервер. Время было позднее, домой уже никто не спешил, поэтому мы
подключили его к сети и нажали пуск. На удивление сервер запустился, несмотря на
10 лет простоя. Была только одна небольшая проблема: сервер был уверен, что
сегодня 1 января 1970 года. И это заставило меня задуматься, как компьютеры
хранят текущее время? У них нет внутри никаких пружин или маятников, которые
могли бы отсчитывать секунды, как в часах. Так как же они показывают верное
время даже если отключить их на несколько часов? И почему наш сервер перепутал время,
только проведя 10 лет в кладовке, а не делал это на каждый перезапуск?

## Маятник как первый секундомер

Чтобы разобраться в этом вопросе, нам стоит сначала дать ответ на то, как мы в
принципе можем точно измерять время. На самом деле, это не такая простая задача,
когда под рукой нет часов. Да, мы всё ещё можем отсчитывать дни, месяцы и годы,
мы даже можем разбить день на часы. Но тяжело найти ориентир, который мог бы нам
подсказать количество прошедших секунд.

Традиционно принято считать, что первым эту задачу решил итальянский ученый XVII
века [Галилео Галилей](https://ru.wikipedia.org/wiki/%D0%93%D0%B0%D0%BB%D0%B8%D0%BB%D0%B5%D0%B9,_%D0%93%D0%B0%D0%BB%D0%B8%D0%BB%D0%B5%D0%BE).
Его биографы утверждают, что Галилео, которому нужно было точно знать, сколько длился
тот или иной эксперимент, для измерения времени считал количество своих
сердцебиений. По легенде, однажды он наблюдал за раскачивающимся канделябром в кафедральном
соборе Пизы и заметил, что каждое колебание канделябра занимало одинаковое
количество сердцебиений, и не изменялось даже со временем, когда амплитуда
движения затухала. Таким образом он понял, что колебания маятника позволяют
более точно засекать время.

## Можно ли использовать колебания для подсчета времени в компьютере

Когда в 70-е - 80-е годы инженеры впервые столкнулись с задачей отсчета
человеческого времени, как ни странно, они обратились к трудам итальянского ученого.
Дело в том, что маятник - не единственный возможный источник колебаний. У любого
современного персонального компьютера есть своеобразное "сердце" - Центральное
процессорное устройство (ЦПУ) или просто процессор. Это очень сложное устройство,
которое выполняет множество функций, но для нас важно то, что внутри него есть
небольшое устройство, которое, когда через него проходит ток, испускает равномерные
электрические колебания с одинаковой [частотой](https://en.wikipedia.org/wiki/Clock_rate).
Частота этих колебаний измеряется в Герцах (Гц) и определяет количество операций,
которое процессор может выполнить за одну секунду.

Представим, что у нас есть одноядерный процессор с частотой 1 Гц. Такой процессор
может выполнять одну операцию за одну секунду, и чтобы отсчитывать с его помощью
время мы можем просто хранить количество колебаний процессора. К сожалению,
если мы будем использовать единственную доступную нам операцию в секунду для
увеличения счетчика колебаний, то наш процессор будет совершенно непригоден
для чего либо ещё, потому что для остальных программ не останется места.
Конечно, современные процессоры не такие медленные, их частота измеряется в
Гигагерцах (ГГц), то есть в 1 000 000 000 операций в секунду. Но даже имея
такую мощь, чтобы засечь время, нам бы пришлось считать каждое колебание процессора.

Для решения этой проблемы был придуман кварцевый генератор. Это устройство
представляет собой тончайшую кремниевую пластину, которая под воздействием
электрического напряжения начинает равномерно расширяться и сжиматься обратно,
[генерируя небольшой электрический заряд на своей поверхности](https://ru.wikipedia.org/wiki/%D0%9F%D1%8C%D0%B5%D0%B7%D0%BE%D1%8D%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D1%8D%D1%84%D1%84%D0%B5%D0%BA%D1%82)
Таким образом, механические колебания пластины сопровождаются синхронными, равномерными
колебаниями электрического заряда.

```
                      |            |
                      |------------|
    -->--->--->-->--->| Осциллятор | >>>>>>>>>
      Переменный ток  |------------|  100 Гц
                      |            |
```

Полученные равномерные колебания принято называть таймером, потому что позволяют
процессору синхронизировать производимые им операции во времени. Таким образом,
у компьютера есть свой собственный таймер и своё собственное понимание времени.

## От компьютерного времени к человеческому

Получается, что у компьютера есть таймер, но нет нужды замерять человеческое время,
оно для него довольно бесполезно. Как правило, эту задачу на себя берут операционные
системы (ОС). Поскольку ОС обычно знает, с какой частотой работает кварцевый генератор,
то она знает и сколько времени проходит между каждым срабатыванием таймера
(срабатывание таймера называют тик (tick) или джиффи (jiffy)). Это посчитать
довольно просто, если генератор работает на частоте 100 Гц, то период между
тиками равен 1/100 секунд или 10 миллисекунд. Операционная система создает в памяти
переменную, которую обычно называют jiffies, и увеличивает ее на единицу каждый раз,
когда процессор оповещает ее, что произошел новый тик. Соответственно, чтобы узнать,
как долго включен компьютер, системе достаточно умножить размер периода между тиками
на количество этих самых тиков. А чтобы узнать текущее время, достаточно добавить
прошедшее время к времени на момент старта системы. Но как узнать человеческое время
на момент старта системы?

## RTC (Real Time Clock), или Часы реального времени

Интересно, но первые персональные компьютеры, такие как [IBM PC](https://en.wikipedia.org/wiki/IBM_Personal_Computer#Design_process)
или [Apple II](https://en.wikipedia.org/wiki/Apple_II), не умели следить за тем,
сколько прошло время после выключения, а [спрашивали его на старте](https://www.youtube.com/watch?v=X3aqJQPQKhs).
Для решения этой задачи снова пригодился кварцевый генератор.

<!-- Текст про то, как работает RTC -->

```
                                          RTC
|-------------------- |---------- |-------------------- |
|                     |           |                     |         32 768 Гц
| Литиевая батарейка  | ->->->->  | Кварцевый генератор | >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
|                     | ток       |                     | Равномерные электрические колебания
|                     |           |                     |
|-------------------- |---------- |-------------------- |
```

Частота колебаний на выходе из RTC обычно 32 768 Гц или 2^15 Гц, что удобно
использовать в бинарных счетчиках, которые хранят время. А кремневой пластине для
работы достаточно небольшой литиевой батарейки. Как оказалось, наш старый сервер
перепутал время именно из-за того, что батарейка в его часах реального времени
села от старости: когда сервер запустился, он не смог считать время из RTC и
выставил стандартное стартовое время - 1 января 1970 года.

## Network Time Protocol

Итак, RTC позволяет компьютеру отсчитывать миллисекунды даже когда он выключен.
Но стандартные RTC имеют погрешность 1,7 - 8,6 секунд в день, значит за год они
могут потерять целый час. Поэтому иногда нам приходится поправлять время на
наручных часах или на микроволновке. Но никогда не приходится делать этого на
компьютере. Да и на старте компьютер больше не спрашивает текущее время. Когда
он подключается к сети интернет, он может использовать NTP (Network Time
Protocol - протокол сетевого времени) для того, чтобы синхронизировать время
с сервером точного времени в сети интернет. Этот протокол даже учитывает время
передачи данных между источником и компьютером и компенсирует его. В публичной
сети он позволяет достигать точности 10 мс.

## Как это работает все вместе

```
|       | Включение компьютера   |                       | Периодически опрашивает NTP  |      |
|------ |----------------------- |---------------------- |----------------------------- |----- |
| RTC   | ->->->->               | Операционная система  | ->->->->                     | NTP  |
| RTC   | <-<-<-<-               | Операционная система  | <-<-<-<-                     | NTP  |
|------ |----------------------- |---------------------- |----------------------------- |----- |
|       | Выключение компьютера  |                       |                              |      |
```

Когда наш компьютер выключен, RTC продолжает работу и отсчитывает время.
Когда мы нажимаем кнопку запуска, операционная система забирает время из RTC и
начинает отслеживать время самостоятельно, используя осциллятор. Время от времени,
операционная система по NTP получает точное время и поправляет свой внутренний счетчик.
Когда мы выключаем компьютер, за дело снова берется RTC.

### Y2K bug. (Надо ли вообще про него?)
> "640 килобайт памяти должно быть достаточно для кого угодно".

Билл Гейтс, 1981 г.

На самом деле в истории уже была такая ситуация. В 60-70-е годы прошлого
столетия, когда люди только начали писать программное обеспечение для
компьютеров, компьютерная память стоила больших денег и большинство
компьютеров обходились несколькими килобайтами памяти. Соответственно, память
нужно было экономить и программисты решили записывать даты в формате: ДД.ММ.ГГ.
И, допустим, у нас есть человек по имени Боб, у которого дата рождения записана как
01.11.22. Мы можем догадаться, что раз 2022 год еще не наступил, то вероятно Боб
родился в 1922 году и ему без малого 100 лет.

