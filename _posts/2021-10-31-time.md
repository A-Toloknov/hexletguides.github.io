---
title: Что такое время
subtitle: Или как Ваш компьютер понимает, какой сейчас час
description: Как современный компьютер хранит информацию, сколько сейчас времени,
как он отсчитывает секунды и почему почти никогда не ошибается
image:
author: Вериго Александр
---

Буквально пару дней назад мы на работе разбирали кладовку и наткнулись на наш
самый первый сервер. Время было позднее, домой уже никто не спешил, поэтому мы
подключили его к сети и нажали пуск. На удивление сервер запустился, несмотря на
10 лет простоя. Была только одна небольшая проблема: сервер был уверен, что
сегодня 1 января 1970 года. И это заставило меня задуматься, как компьютеры
хранят текущее время? У них нет внутри никаких пружин или маятников, которые
могли бы отсчитывать секунды, как в часах. Так как же они показывают верное
время даже если отключить их на несколько часов? И почему наш сервер перепутал время,
только проведя 10 лет в кладовке, а не делал это на каждый перезапуск.

## Как первые персональные компьютеры отсчитывали секунды

Интересно, но первые персональные компьютеры, такие как
[IBM PC](https://en.wikipedia.org/wiki/IBM_Personal_Computer#Design_process) или
[Apple II](https://en.wikipedia.org/wiki/Apple_II),
не умели следить за тем, сколько прошло время после выключения, а
[спрашивали его на старте](https://www.youtube.com/watch?v=X3aqJQPQKhs).
После того, как время было задано пользователем, компьютер
увеличивал счетчик времени с равномерным интервалом.

## Так как компьютер определяет, что пора сдвинуть стрелку на часах?

У любого современного персонального компьютера есть своеобразное "сердце" -
Центральное процессорное устройство (ЦПУ) или просто процессор. Это очень сложное
устройство, которое выполняет множество функций, но для нас самое важное то, что
внутри него есть тонкая кремневая пластина, которая, когда через нее проходит
ток, колеблется с одинаковой [частотой](https://en.wikipedia.org/wiki/Clock_rate).
Частота этих колебаний измеряется в Герцах (Гц) и определяет количество операций,
которое процессор может выполнить за одну секунду.

Представим, что у нас есть одноядерный процессор с частотой 1 Гц. Такой процессор
может выполнять одну операцию за одну секунду, и чтобы отсчитывать с его помощью
время нам нужно просто хранить количество колебаний процессора. К сожалению,
если мы будем использовать единственную доступную нам операцию в секунду для
увеличения счетчика колебаний, то наш процессор будет совершенно непригоден
для чего либо ещё, потому что для остальных программ не останется места.
Конечно, современные процессоры не такие медленные, их частота измеряется в
Гигагерцах (ГГц), то есть в 1 000 000 000 операций в секунду. Но даже имея
такую мощь, чтобы засечь время, нам бы пришлось считать каждое колебание процессора.

## Осцилляторы на помощь!

Для решения этой проблемы был придуман кварцевый генератор или осциллятор. Это
устройство может использовать высокочастотные механические колебания (например,
колебания процессора на частоте 1 ГГц), чтобы генерировать электрический сигнал
со значительно более низкой и постоянной частотой, например 100 Гц.

```
            |            |
            |------------|
 --->-->--->| Осциллятор | >>>>>>>>>
    1GHz    |------------|  100 Hz
            |            |
```

Теперь, имея устройство, которое может производить какие-то действия с одинаковыми
интервалами, мы можем на каждое его колебание запускать программу, которая обновляет
счетчик времени. И в целом, это решает проблему отсчета времени, процессор
может по-прежнему спокойно выполнять свои миллиарды операций в секунду и 100 раз
в секунду мы будем двигать стрелку часов. Но когда компьютер выключен, процессор
не испускает никаких колебаний, а значит и время стоит на месте.

## RTC (Real Time Clock), или Часы реального времени

На самом деле, если подумать, то кварцевому генератору не очень важно, какое
именно устройство создает механические колебания, вовсе не обязательно, чтобы
это был именно процессор. Мы можем взять другую кварцевую пластину,
заставить ее колебаться, пустив по ней ток, и соединить с осциллятором для
получения электрических сигналов постоянной частоты.

```
                                          RTC
|-------------------- |---------- |-------------------- |------------------------ |------------ |
|                     |           |                     |                         |             |         32 768 Гц
| Литиевая батарейка  | ->->->->  | Кремневая пластина  | ->->->->->->->->->->->  | Осциллятор  | >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
|                     | ток       |                     | механические колебания  |             | Равномерные электрические колебания
|                     |           |                     |                         |             |
|-------------------- |---------- |-------------------- |------------------------ |------------ |
```

Частота колебаний на выходе из RTC обычно 32 768 Гц или 2^15 Гц, что удобно
использовать в бинарных счетчиках, которые хранят время. А кремневой пластине для
работы достаточно небольшой литиевой батарейки. Как оказалось, наш старый сервер
перепутал время именно из-за того, что батарейка в его часах реального времени
села от старости: когда сервер запустился, он не смог считать время из RTC и
выставил стандартное стартовое время - 1 января 1970 года.

## Network Time Protocol

Итак, RTC позволяет компьютеру отсчитывать миллисекунды даже когда он выключен.
Но стандартные RTC имеют погрешность 1,7 - 8,6 секунд в день, значит за год они
могут потерять целый час. Поэтому иногда нам приходится поправлять время на
наручных часах или на микроволновке. Но никогда не приходится делать этого на
компьютере. Да и на старте компьютер больше не спрашивает текущее время. Когда
он подключается к сети интернет, он может использовать NTP (Network Time
Protocol - протокол сетевого времени) для того, чтобы синхронизировать время
с сервером точного времени в сети интернет. Этот протокол даже учитывает время
передачи данных между источником и компьютером и компенсирует его. В публичной
сети он позволяет достигать точности 10 мс.

## Как это работает все вместе

```
|       | Включение компьютера   |                       | Периодически опрашивает NTP  |      |
|------ |----------------------- |---------------------- |----------------------------- |----- |
| RTC   | ->->->->               | Операционная система  | ->->->->                     | NTP  |
| RTC   | <-<-<-<-               | Операционная система  | <-<-<-<-                     | NTP  |
|------ |----------------------- |---------------------- |----------------------------- |----- |
|       | Выключение компьютера  |                       |                              |      |
```

Когда наш компьютер выключен, RTC продолжает работу и отсчитывает время.
Когда мы нажимаем кнопку запуска, операционная система забирает время из RTC и
начинает отслеживать время самостоятельно, используя осциллятор. Время от времени,
операционная система по NTP получает точное время и поправляет свой внутренний счетчик.
Когда мы выключаем компьютер, за дело снова берется RTC.

## Заголовок про то, как системное время используют программисты

Все это время мы обсуждали то, как компьютер хранит время внутри, "под капотом".
А как им пользуются люди? У нас есть счетчик, который умеет накручивать секунды,
значит, чтобы узнать текущее время, нам достаточно прибавить эти секунды к некой
дате. Такую дату принято называть [Epoch](https://en.wikipedia.org/wiki/Epoch_(computing))
и в операционных системах семейства Unix - это полночь 1 января 1970 года.
Операционная система выделяет место в памяти компьютера, в котором хранит
количество секунд, прошедших с момента epoch. Обычно это место фиксированное, значит,
теоретически оно может закончиться. А что тогда?

### Y2K bug. (Надо ли вообще про него?)
> "640 килобайт памяти должно быть достаточно для кого угодно".

Билл Гейтс, 1981 г.

На самом деле в истории уже была такая ситуация. В 60-70-е годы прошлого
столетия, когда люди только начали писать программное обеспечение для
компьютеров, компьютерная память стоила больших денег и большинство
компьютеров обходились несколькими килобайтами памяти. Соответственно, память
нужно было экономить и программисты решили записывать даты в формате: ДД.ММ.ГГ.
И, допустим, у нас есть человек по имени Боб, у которого дата рождения записана как
01.11.22. Мы можем догадаться, что раз 2022 год еще не наступил, то вероятно Боб
родился в 1922 году и ему без малого 100 лет.

